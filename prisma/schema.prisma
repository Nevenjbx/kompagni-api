// ==============================================
// CONFIGURATION PRISMA
// ==============================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// ==============================================
// ENUMS (Types énumérés)
// ==============================================

enum Role {
  CLIENT      // Propriétaire d'animal
  PROVIDER    // Prestataire (toiletteur, véto, etc.)
  ADMIN       // Administrateur
}

enum AppointmentStatus {
  PENDING     // En attente de confirmation
  CONFIRMED   // Confirmé
  COMPLETED   // Terminé
  CANCELLED   // Annulé
}

enum AnimalType {
  DOG         // Chien
  CAT         // Chat
  OTHER       // Autre
}

// ==============================================
// MODÈLES (Tables)
// ==============================================

// Table des utilisateurs (clients et prestataires)
model User {
  id            String    @id @default(uuid())
  email         String    @unique
  firstName     String?   // Prénom
  lastName      String?   // Nom de famille
  phoneNumber   String?
  role          Role      @default(CLIENT)
  
  isDeleted     Boolean   @default(false) // Soft delete flag
  
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  
  // Relations
  providerProfile ProviderProfile? // Si prestataire
  appointments    Appointment[]    // Rendez-vous pris (si client) ou reçus (si prestataire)
  pets            Pet[]
  favoriteProviders ProviderProfile[] @relation("UserFavorites") // New relation

  @@map("users")
}

enum PetSize {
  SMALL
  MEDIUM
  LARGE
  GIANT
}

enum PetCharacter {
  HAPPY
  ANGRY
  CALM
  SCARED
  ENERGETIC
}

model Pet {
  id        String       @id @default(uuid())
  ownerId   String
  name      String
  type      AnimalType
  breed     String
  size      PetSize
  character PetCharacter

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relation
  owner     User     @relation(fields: [ownerId], references: [id], onDelete: Cascade)

  @@map("pets")
}

// Profil prestataire (toiletteur, véto, etc.)
model ProviderProfile {
  id              String   @id @default(uuid())
  userId          String   @unique
  businessName    String   // Nom du salon/cabinet
  description     String?
  address         String
  city            String
  postalCode      String
  latitude        Float?
  longitude       Float?
  tags            String[]
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  user            User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  services        Service[]
  workingHours    WorkingHours[]
  absences        ProviderAbsence[]
  appointments    Appointment[]
  favoritedBy     User[]            @relation("UserFavorites") // New relation

  @@map("provider_profiles")
}

// Services proposés par les prestataires
model Service {
  id              String      @id @default(uuid())
  providerId      String
  name            String      // Ex: "Toilettage complet chien"
  description     String?
  duration        Int         // Durée en minutes
  price           Float       // Prix en euros
  animalType      AnimalType
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  provider        ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  appointments    Appointment[]
  
  @@map("services")
}

// Horaires de travail des prestataires
model WorkingHours {
  id              String   @id @default(uuid())
  providerId      String
  dayOfWeek       Int      // 0 = Dimanche, 1 = Lundi, ..., 6 = Samedi
  startTime       String   // Format "09:00"
  endTime         String   // Format "18:00"
  breakStartTime  String?  // Format "12:00" (Optional)
  breakEndTime    String?  // Format "13:00" (Optional)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  provider        ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  
  @@map("working_hours")
}

// Absences / Vacances
model ProviderAbsence {
  id              String   @id @default(uuid())
  providerId      String
  
  startDate       DateTime
  endDate         DateTime
  reason          String?
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  provider        ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  
  @@map("provider_absences")
}

// Rendez-vous
model Appointment {
  id              String             @id @default(uuid())
  clientId        String
  providerId      String
  serviceId       String
  
  startTime       DateTime
  endTime         DateTime
  status          AppointmentStatus  @default(PENDING)
  notes           String?            // Notes du client
  
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  
  // Relations
  client          User               @relation(fields: [clientId], references: [id], onDelete: Cascade)
  provider        ProviderProfile    @relation(fields: [providerId], references: [id], onDelete: Cascade)
  service         Service            @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  
  @@map("appointments")
  @@index([providerId, startTime]) // Optimize availability checks
  @@index([clientId, startTime])   // Optimize client history
}